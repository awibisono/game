<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Island: Synchronized Ecosystem</title>
  <style>
    body { margin: 0; overflow: hidden; background: #050a10; font-family: 'Verdana', sans-serif; color: #e9eef5; }
    canvas { display: block; cursor: crosshair; }
    
    #ui {
        position: absolute; top: 20px; left: 20px;
        background: rgba(10, 15, 25, 0.85);
        padding: 15px; border: 1px solid rgba(0, 188, 212, 0.4);
        border-radius: 10px; pointer-events: none;
        backdrop-filter: blur(5px);
    }
    h1 { margin: 0 0 5px 0; font-size: 1.1rem; color: #00bcd4; letter-spacing: 1px; }
    .stat { font-size: 0.85rem; color: #8899aa; }
    
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; color: #00bcd4; font-weight: bold; }

    /* STAT CARD POPUP */
    #stat-card {
        display: none;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 340px;
        background: rgba(20, 25, 35, 0.95);
        border: 2px solid #00bcd4;
        border-radius: 15px;
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 188, 212, 0.2);
        padding: 25px;
        z-index: 100;
        backdrop-filter: blur(10px);
    }
    #stat-card h2 { margin-top: 0; color: #fff; text-transform: uppercase; border-bottom: 1px solid #334455; padding-bottom: 10px; letter-spacing: 2px; }
    #stat-card .portrait-wrap { width: 80px; height: 80px; margin: 0 auto 15px auto; border: 3px solid #334455; border-radius: 50%; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; }
    #stat-card canvas.portrait { width: 64px; height: 64px; image-rendering: pixelated; }
    #stat-card .row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; }
    #stat-card .label { color: #778899; text-transform: uppercase; font-size: 0.75rem; }
    #stat-card .val { color: #eee; font-weight: bold; }
    #stat-card button { width: 100%; margin-top: 20px; padding: 12px; background: #00bcd4; color: #000; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.2s; }
    #stat-card button:hover { background: #00e5ff; transform: scale(1.02); }

    /* PROGRESS BARS */
    .bar-bg { width: 100%; height: 6px; background: #111; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.5s ease-in-out; }

  </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="loading">SYNCHRONIZING WITH WORLD STATE...</div>

<div id="ui" style="display:none;">
    <h1>ISLAND SENSOR</h1>
    <div class="stat">TEMPORAL PHASE: WEEK <span id="val-week">0</span></div>
    <div class="stat">BIOMASS COUNT: <span id="val-pop">0</span> AGENTS</div>
    <div class="stat" style="margin-top:10px; font-size:0.75em; color:#556677;">Dynamics: McKean-Vlasov SDE (Synchronized)</div>
</div>

<div id="stat-card">
    <div class="portrait-wrap"><canvas id="card-portrait" width="64" height="64" class="portrait"></canvas></div>
    <h2 id="card-name" style="text-align:center;">Name</h2>
    
    <div class="row"><span class="label">Classification</span> <span class="val" id="card-type">TYPE</span></div>
    <div class="row"><span class="label">Temporal State</span> <span class="val" id="card-status">Active</span></div>
    
    <div style="margin-top:15px;">
        <div class="label">Vitality (HP)</div>
        <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="width: 100%; background: #66bb6a;"></div></div>
    </div>

    <div class="row"><span class="label">Evolutionary XP</span> <span class="val" id="card-xp">0</span></div>
    <div class="row"><span class="label">Velocity Magnitude</span> <span class="val" id="card-vel">0.00</span></div>
    
    <div style="margin-top:15px; font-size:0.8rem; color:#8899aa; font-style:italic; text-align:center;" id="card-personality">
        "Prefers the damp shadows of the forest."
    </div>

    <button onclick="closeCard()">DISMISS</button>
</div>

<!-- Load Engine -->
<script src="js/sim_engine.js"></script>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let W, H;
    let engine = null;
    let bgCanvas = null;
    let selectedAgent = null;
    let particles = []; // Wind/Environment particles

    const sprites = {
        'R': { img: new Image(), src: 'images/chars/red-walk.png', loaded: false },
        'G': { img: new Image(), src: 'images/chars/green-walk.png', loaded: false },
        'B': { img: new Image(), src: 'images/chars/blue-walk.png', loaded: false }
    };

    Object.keys(sprites).forEach(k => {
        sprites[k].img.src = sprites[k].src;
        sprites[k].img.onload = () => sprites[k].loaded = true;
    });

    // --- WIND PARTICLES ---
    function initWeather() {
        for(let i=0; i<60; i++) {
            particles.push({
                x: (Math.random() - 0.5) * 3.5,
                y: (Math.random() - 0.5) * 3.5,
                size: 1 + Math.random() * 2,
                alpha: 0.1 + Math.random() * 0.4
            });
        }
    }

    // --- INTERACTION ---
    canvas.addEventListener('click', (e) => {
        if(!engine) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        let found = null;
        let minDist = 40;

        engine.data.agents.forEach(a => {
            const [sx, sy] = worldToScreen(a.pos[0], a.pos[1]);
            const d = Math.hypot(sx - mx, sy - my);
            if(d < minDist) { minDist = d; found = a; }
        });
        if(found) openCard(found);
        else closeCard();
    });

    function openCard(agent) {
        selectedAgent = agent;
        const card = document.getElementById('stat-card');
        document.getElementById('stat-card').style.display = 'block';
        document.getElementById('card-name').innerText = agent.name;
        document.getElementById('card-hp').innerText = Math.round(agent.stats.hp) + "/100";
        document.getElementById('card-xp').innerText = agent.stats.xp;
        document.getElementById('card-status').innerText = agent.status.toUpperCase();
        document.getElementById('card-vel').innerText = Math.hypot(agent.vx, agent.vy).toFixed(4);
        
        const hpBar = document.getElementById('hp-bar');
        hpBar.style.width = agent.stats.hp + "%";
        hpBar.style.background = agent.stats.hp > 50 ? '#66bb6a' : (agent.stats.hp > 20 ? '#fbc02d' : '#ff5252');

        const pers = {
            'R': "Driven by the heat of the volcano. Aggressive and fast.",
            'G': "Seeking harmony in the deep forest elevations.",
            'B': "Drawn to the low-lying murky swamp waters."
        };
        document.getElementById('card-personality').innerText = `"${pers[agent.type]}"`;

        // Portrait
        const pCtx = document.getElementById('card-portrait').getContext('2d');
        pCtx.clearRect(0,0,64,64);
        if(sprites[agent.type].loaded) {
            const img = sprites[agent.type].img;
            const fw = img.width / 4;
            pCtx.drawImage(img, 0, 0, fw, img.height, 0, 0, 64, 64);
        }
    }

    window.closeCard = () => { document.getElementById('stat-card').style.display = 'none'; selectedAgent = null; };

    // --- RENDERING ---
    function drawAgent(a, ctx) {
        let [sx, sy] = worldToScreen(a.pos[0], a.pos[1]);
        sx = Math.round(sx); sy = Math.round(sy);
        
        const asset = sprites[a.type];
        if (asset && asset.loaded) {
            const speed = Math.hypot(a.vx, a.vy);
            const frame = speed > 0.05 ? Math.floor(Date.now() / 120) % 4 : 0;
            const img = asset.img;
            const fw = Math.floor(img.width / 4);
            const fh = img.height;
            
            ctx.save();
            ctx.translate(sx, sy);
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, 0, 12, 6, 0, 0, Math.PI*2); ctx.fill();

            if (a.vx < 0) ctx.scale(-1, 1);
            
            const size = 48;
            // Perfect Centering: -size/2, and align bottom (-size + offset)
            ctx.drawImage(img, 
                frame * fw, 0, fw, fh, 
                -size/2, -size + 10, size, size
            );
            
            if(selectedAgent === a) {
                if (a.vx < 0) ctx.scale(-1, 1); 
                ctx.strokeStyle = '#00bcd4'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0, -15, 25, 0, Math.PI*2); ctx.stroke();
            }
            ctx.restore();
        }
    }

    function drawFood(f, ctx) {
        const [sx, sy] = worldToScreen(f.x, f.y);
        const pulse = 1 + Math.sin(Date.now() * 0.005) * 0.2;
        ctx.fillStyle = f.type === 'R' ? '#ff5252' : (f.type === 'G' ? '#66bb6a' : '#4fc3f7');
        ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
        ctx.beginPath(); ctx.arc(sx, sy, 4 * pulse, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    }

    function renderWeather(ctx) {
        particles.forEach(p => {
            const wind = engine.getWind(p.x, p.y, engine.time);
            p.x += wind.x * 0.01; p.y += wind.y * 0.01;
            if(p.x < -2) p.x = 2; if(p.x > 2) p.x = -2;
            if(p.y < -2) p.y = 2; if(p.y > 2) p.y = -2;
            const [sx, sy] = worldToScreen(p.x, p.y);
            ctx.fillStyle = `rgba(255,255,255,${p.alpha})`;
            ctx.fillRect(sx, sy, p.size, p.size);
        });
    }

    function worldToScreen(x, y) {
        const xmin = -1.75, xmax = 1.75, ymin = -1.75, ymax = 1.75;
        return [(x - xmin) / (xmax - xmin) * W, (1 - (y - ymin) / (ymax - ymin)) * H];
    }
    
    function screenToWorld(sx, sy) {
        const xmin = -1.75, xmax = 1.75, ymin = -1.75, ymax = 1.75;
        return [xmin + (sx / W) * (xmax - xmin), ymin + (1 - sy / H) * (ymax - ymin)];
    }

    function renderTerrain() {
        if(!bgCanvas) {
            bgCanvas = document.createElement('canvas');
            bgCanvas.width = W; bgCanvas.height = H;
            const bCtx = bgCanvas.getContext('2d');
            const img = bCtx.createImageData(W, H);
            const data = img.data;
            for(let sy=0; sy<H; sy+=2) {
                for(let sx=0; sx<W; sx+=2) {
                    const [wx, wy] = screenToWorld(sx, sy);
                    const m = islandMask(wx, wy, 1337);
                    const c = getTerrainColor(m, wx, wy, 1337);
                    const idx = 4 * (sy*W + sx);
                    for(let i=0; i<8; i++) data[idx+i] = c[i%4]; // rough fill
                    data[idx] = c[0]; data[idx+1] = c[1]; data[idx+2] = c[2]; data[idx+3] = 255;
                }
            }
            bCtx.putImageData(img, 0, 0);
            const g = bCtx.createRadialGradient(W/2, H/2, W*0.1, W/2, H/2, W*0.7);
            g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, 'rgba(0,0,0,0.5)');
            bCtx.fillStyle = g; bCtx.fillRect(0,0,W,H);
        }
        ctx.drawImage(bgCanvas, 0, 0);
    }

    function loop() {
        if(!engine) return;
        engine.step();
        renderTerrain();
        renderWeather(ctx);
        if(engine.data.food) engine.data.food.forEach(f => drawFood(f, ctx));
        engine.data.agents.forEach(a => drawAgent(a, ctx));
        requestAnimationFrame(loop);
    }

    async function init() {
        try {
            const res = await fetch('data/world.json?nocache=' + Date.now());
            const data = await res.json();
            engine = new Engine(data);
            initWeather();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('val-week').innerText = data.meta.week;
            document.getElementById('val-pop').innerText = data.agents.length;
            resize();
            loop();
        } catch(e) { document.getElementById('loading').innerText = "LINK FAILURE"; console.error(e); }
    }

    function resize() { W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H; bgCanvas = null; }
    window.addEventListener('resize', resize);
    init();
</script>
</body>
</html>