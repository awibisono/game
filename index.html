<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CPSC 4860: The Chthonic Kernel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=VT323&display=swap');

        :root {
            --bg-color: #050508;
            --term-color: #111116;
            --text-color: #d0d0e0;
            --accent-color: #88ccff;
            --highlight-color: #ffd700;
            --danger-color: #ff6b6b;
            --magic-color: #e0aaff;
            --font-main: 'VT323', monospace; /* Retro Terminal Font */
            --font-code: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            font-size: 1.2rem;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- CRT SCANLINE EFFECT --- */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        
        /* Flicker Animation */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.95; }
            10% { opacity: 0.9; }
            15% { opacity: 0.95; }
            20% { opacity: 0.98; }
            50% { opacity: 0.95; }
            100% { opacity: 0.98; }
        }

        /* Shake Animation for Damage */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0); }
        }

        .shake-screen {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* --- HUD (Heads Up Display) --- */
        #hud {
            background-color: #0a0a10;
            border-bottom: 2px solid #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            font-family: var(--font-code);
            font-size: 0.85rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .stat-box { display: flex; gap: 20px; }
        .stat-label { color: #666; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .val-hp { color: var(--danger-color); text-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
        .val-mp { color: var(--accent-color); text-shadow: 0 0 5px rgba(136, 204, 255, 0.5); }
        
        #location-display { 
            color: var(--highlight-color); 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        /* --- TERMINAL (Game Log) --- */
        #terminal {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            background-color: var(--bg-color);
            position: relative;
            z-index: 1;
        }

        /* Custom Scrollbar */
        #terminal::-webkit-scrollbar { width: 8px; }
        #terminal::-webkit-scrollbar-track { background: #111; }
        #terminal::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        #terminal::-webkit-scrollbar-thumb:hover { background: #555; }

        .log-entry { 
            opacity: 0; 
            animation: fadeIn 0.4s ease-out forwards; 
            line-height: 1.5;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .msg-narrator { color: #bbbbcc; }
        .msg-player { color: var(--accent-color); font-weight: bold; border-left: 2px solid var(--accent-color); padding-left: 10px; }
        .msg-npc { color: var(--highlight-color); font-style: italic; }
        .msg-danger { color: var(--danger-color); font-weight: bold; text-shadow: 0 0 3px rgba(255, 0, 0, 0.3); }
        .msg-magic { color: var(--magic-color); text-shadow: 0 0 5px rgba(224, 170, 255, 0.4); }
        .msg-system { color: #55ff55; font-size: 0.9em; font-family: var(--font-code); opacity: 0.8; }

        /* --- CONTROLS --- */
        #controls {
            background-color: var(--term-color);
            border-top: 1px solid #222;
            padding: 15px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        #input-line {
            display: flex;
            gap: 10px;
        }

        #cmd-input {
            flex-grow: 1;
            background: #08080c;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            font-family: var(--font-code);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        #cmd-input:focus { outline: none; border-color: var(--accent-color); }

        #send-btn {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 0 25px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-code);
            font-weight: bold;
            transition: all 0.2s;
        }
        #send-btn:hover { background: #333; border-color: #666; }
        #send-btn:active { transform: scale(0.95); }

        /* --- MOBILE BUTTON GRID --- */
        #quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .btn {
            background: linear-gradient(145deg, #2a2a35, #22222d);
            color: #ccc;
            border: 1px solid #3a3a45;
            padding: 15px 5px;
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-main);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: manipulation;
            box-shadow: 0 4px 0 #15151a;
        }

        .btn:active { 
            transform: translateY(4px); 
            box-shadow: 0 0 0 #15151a; 
        }

        .btn-move { border-bottom: 3px solid #446; }
        .btn-act { border-bottom: 3px solid #644; color: #ffcccc; }
        
        /* Combat Buttons Glow */
        .btn-combat { 
            background: linear-gradient(145deg, #422, #311); 
            border-color: #a44; 
            color: #ffa; 
            display: none; 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 85, 85, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(255, 85, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 85, 85, 0); }
        }

        /* Media Query for larger screens */
        @media (min-width: 768px) {
            .container { max-width: 800px; margin: 0 auto; border: 1px solid #333; height: 90vh; margin-top: 5vh; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
            body { background-color: #020202; justify-content: center; align-items: center; }
            #hud, #terminal, #controls { width: 800px; max-width: 100%; border-left: 1px solid #222; border-right: 1px solid #222; }
            #terminal { height: 60vh; }
            #quick-actions { grid-template-columns: repeat(6, 1fr); }
        }
    </style>
</head>
<body>

    <!-- HUD -->
    <div id="hud">
        <div class="stat-box">
            <div><span class="stat-label">Psyche</span> <span id="hp-val" class="val-hp">30/30</span></div>
            <div><span class="stat-label">Techne</span> <span id="mp-val" class="val-mp">10/10</span></div>
        </div>
        <div id="location-display">Sterling Library</div>
    </div>

    <!-- TERMINAL LOG -->
    <div id="terminal" id="log-container">
        <!-- Text gets injected here -->
    </div>

    <!-- CONTROLS -->
    <div id="controls">
        <!-- Quick Action Buttons for Mobile/Tablet -->
        <div id="quick-actions">
            <!-- Exploration Buttons -->
            <button class="btn btn-move expl-btn" onclick="engine.handleInput('north')">N</button>
            <button class="btn btn-move expl-btn" onclick="engine.handleInput('south')">S</button>
            <button class="btn btn-move expl-btn" onclick="engine.handleInput('west')">W</button>
            <button class="btn btn-move expl-btn" onclick="engine.handleInput('east')">E</button>
            <button class="btn expl-btn" onclick="engine.handleInput('look')">Look</button>
            <button class="btn expl-btn" onclick="engine.handleInput('talk')">Talk</button>
            
            <!-- Combat Buttons -->
            <button class="btn btn-combat" onclick="engine.handleInput('argue')">Argue</button>
            <button class="btn btn-combat" onclick="engine.handleInput('logic')">Logic</button>
            <button class="btn btn-combat" onclick="engine.handleInput('thesis')">Thesis</button>
            <button class="btn btn-combat" onclick="engine.handleInput('flee')">Flee</button>
        </div>

        <!-- Text Input Line -->
        <div id="input-line">
            <input type="text" id="cmd-input" placeholder="Enter command..." autocomplete="off">
            <button id="send-btn" onclick="submitCommand()">RUN</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const ELEMENTS = {
            FIRE: "Phlegethon", 
            ICE: "Cocytus",     
            SKY: "Aether",      
            VOID: "Styx"        
        };

        // --- GAME STATE ---
        const GameState = {
            mode: "INTRO", // INTRO, EXPLORE, COMBAT, DIALOGUE
            player: {
                name: "Neophyte",
                major: null, // "THEORIST", "ENGINEER", "HISTORIAN"
                // Base Stats (Will be modified by Major)
                psyche: 30, maxPsyche: 30, 
                techne: 15, maxTechne: 15,
                rhetoric: 5,
                dialect: 3,
                theory: 4,
                latency: 10,
                memories: [], // Unlocked lore fragments
                inventory: ["Student ID"],
                location: "hub"
            },
            combat: {
                target: null,
                turn: 0
            },
            dialogue: {
                npc: null,
                node: "start"
            },
            flags: {
                metDan: false,
                cycleCount: 2048,
            }
        };

        const Memories = [
            "LOG 0x01: I remember... sunlight? No, it was the glow of a monitor. I was writing a thesis on 'Recursive Soul Generation'.",
            "LOG 0x0A: The Provost isn't a person. It's a cleanup script. It deletes 'Graduates' to free up memory.",
            "LOG 0xFF: I am not a student. I am the Exception Handler. I was sent here to catch the error that broke the world."
        ];

        const Majors = {
            "THEORIST": {
                name: "College of Aether (Theory)",
                desc: "Followers of Pure Logic. High Magic (Theory), Low Defense.",
                bonus: { theory: 3, techne: 5, dialect: -1 }
            },
            "ENGINEER": {
                name: "Forge of Phlegethon (Systems)",
                desc: "Builders of the Hard Iron. High Attack (Rhetoric), Low Speed.",
                bonus: { rhetoric: 3, psyche: 10, latency: 2 }
            },
            "HISTORIAN": {
                name: "Library of Styx (Legacy)",
                desc: "Keepers of the Old Code. High Defense (Dialect), Balanced.",
                bonus: { dialect: 3, psyche: 5, techne: 5 }
            }
        };

        const World = {
            "hub": {
                name: "The Great Hall of Harkness",
                desc: "You stand in the central hub. To the NORTH is the Sky Spire. To the SOUTH is the Sunken Library. To the EAST is the Silicon Furnace. To the WEST is the Crypt.",
                exits: { "north": "sky_gate", "south": "sea_gate", "east": "fire_gate", "west": "spirit_gate" },
                npc: "Cerberus Dan",
                encounterRate: 0
            },
            "sky_gate": {
                name: "Gate of Aether",
                desc: "A floating platform. Clouds swirl. The Spire rises infinitely.",
                exits: { "south": "hub", "north": "cloud_campus" },
                encounterRate: 0.3,
                enemies: ["Syntax Harpy"]
            },
            "cloud_campus": {
                name: "The Cloud Campus",
                desc: "Data packets rain like hail. The air smells of ozone.",
                exits: { "south": "sky_gate", "north": "spire_top" },
                encounterRate: 0.5,
                enemies: ["Syntax Harpy", "Cloud Demon"]
            },
            "spire_top": {
                name: "Peak of the Spire",
                desc: "You are at the edge of the atmosphere.",
                exits: { "south": "cloud_campus" },
                npc: "Prof. Nephele"
            },
            "sea_gate": {
                name: "The Sunken Library Entry",
                desc: "Steps lead down into dark water.",
                exits: { "north": "hub", "south": "river_styx" },
                encounterRate: 0.3,
                enemies: ["Memory Minotaur"]
            },
            "river_styx": {
                name: "The River Styx",
                desc: "Black water flows through the corridors.",
                exits: { "north": "sea_gate", "south": "abyssal_lab" },
                encounterRate: 0.5,
                enemies: ["Memory Minotaur", "Leakage Spirit"]
            },
            "abyssal_lab": {
                name: "The Abyssal Lab",
                desc: "Bioluminescent specimens float in jars.",
                exits: { "north": "river_styx" },
                npc: "Coach Pontus"
            },
            "fire_gate": {
                name: "Entrance to Phlegethon",
                desc: "The heat is oppressive.",
                exits: { "west": "hub", "east": "silicon_furnace" },
                encounterRate: 0.3,
                enemies: ["Overheat Imp"]
            },
            "silicon_furnace": {
                name: "The Silicon Furnace",
                desc: "Lava flows in circuit patterns.",
                exits: { "west": "fire_gate", "east": "core_foundry" },
                encounterRate: 0.5,
                enemies: ["Overheat Imp", "Slag Golem"]
            },
            "core_foundry": {
                name: "The Core Foundry",
                desc: "The heart of the machine.",
                exits: { "west": "silicon_furnace" },
                npc: "Dean Hephaestus"
            },
            "spirit_gate": {
                name: "Crypt of Erebus",
                desc: "The light fades here.",
                exits: { "east": "hub", "west": "null_void" },
                encounterRate: 0.3,
                enemies: ["Null Shade"]
            },
            "null_void": {
                name: "The Null Void",
                desc: "Pointers reference nothing here.",
                exits: { "east": "spirit_gate", "west": "necropolis" },
                encounterRate: 0.5,
                enemies: ["Null Shade", "Segmentation Ghost"]
            },
            "necropolis": {
                name: "The Sterling Necropolis",
                desc: "Rows of tombstones labeled with deprecated functions.",
                exits: { "east": "null_void" },
                npc: "Librarian Persephone"
            }
        };

        const Bestiary = {
            "Syntax Harpy": { hp: 20, att: 4, def: 2, element: ELEMENTS.SKY, xp: 10, desc: "A screeching bird made of broken brackets." },
            "Memory Minotaur": { hp: 35, att: 6, def: 4, element: ELEMENTS.ICE, xp: 20, desc: "A beast wandering the labyrinth of the heap." },
            "Overheat Imp": { hp: 15, att: 8, def: 1, element: ELEMENTS.FIRE, xp: 10, desc: "A fast, burning glitch." },
            "Null Shade": { hp: 25, att: 5, def: 5, element: ELEMENTS.VOID, xp: 15, desc: "A shadow that consumes data." },
            // Archons
            "Prof. Nephele": { hp: 100, att: 12, def: 8, element: ELEMENTS.SKY, boss: true, desc: "Archon of the Cloud." },
            "Coach Pontus": { hp: 120, att: 10, def: 10, element: ELEMENTS.ICE, boss: true, desc: "Archon of the Stream." },
            "Dean Hephaestus": { hp: 140, att: 15, def: 12, element: ELEMENTS.FIRE, boss: true, desc: "Archon of the Forge." },
            "Librarian Persephone": { hp: 90, att: 18, def: 5, element: ELEMENTS.VOID, boss: true, desc: "Archon of the Deep." }
        };

        const NPCs = {
            "Cerberus Dan": {
                name: "Cerberus Dan",
                dialogue: {
                    "start": {
                        text: "Woof. Logic error detected. You are not authorized, yet you exist. Strange.",
                        options: {
                            "1": { text: "Who are you?", next: "who" },
                            "2": { text: "Where am I?", next: "where" },
                            "3": { text: "Pet the dog.", next: "pet" }
                        }
                    },
                    "who": {
                        text: "I am the Guardian of the Gateway. I sniff out bugs and bad pointers. You smell like... a memory leak.",
                        options: { "1": { text: "Back.", next: "start" } }
                    },
                    "where": {
                        text: "The Chthonic Kernel. The Underworld of deleted data. The Archons rule the sectors above.",
                        options: { "1": { text: "Back.", next: "start" } }
                    },
                    "pet": {
                        text: "*The three heads wage their tails in unison.* Access granted. Good Neophyte.",
                        options: { "1": { text: "Back.", next: "start" } }
                    }
                }
            },
            "Prof. Nephele": { name: "Archon Nephele", dialogue: ["You cannot comprehend the altitude of my intellect!", "PREPARE TO BE DEPRECATED!"], hostile: true },
            "Coach Pontus": { name: "Archon Pontus", dialogue: ["Row for your life!", "I will drown you in work!"], hostile: true },
            "Dean Hephaestus": { name: "Archon Hephaestus", dialogue: ["I forge engineers from the raw ore of freshmen!", "Burn!"], hostile: true },
            "Librarian Persephone": { name: "Archon Persephone", dialogue: ["Shhh. Quiet hours.", "Fade into silence."], hostile: true },
            "Provost of Entropy": { name: "The Provost", dialogue: ["Your thesis is due.", "End of Line."], hostile: true }
        };

        const Engine = {
            init: function() {
                this.log("System Boot... Cycle #2049 Initiated.", "system");
                this.log("Searching for <span style='color:var(--accent-color)'>User.Soul</span>... Found.", "system");
                this.log("<br><strong>THE CHTHONIC KERNEL</strong>", "msg-player");
                this.log("You drift in the void between 0 and 1. You are a Neophyte, a soul undefined.", "narrator");
                this.log("To enter the University of the Dead, you must declare your Major.", "narrator");
                
                this.log("<br>Select your path:", "system");
                this.log("1. <strong>THEORIST</strong> (College of Aether) - Power through Logic.", "msg-magic");
                this.log("2. <strong>ENGINEER</strong> (Forge of Phlegethon) - Strength through Hardware.", "danger");
                this.log("3. <strong>HISTORIAN</strong> (Library of Styx) - Endurance through Legacy.", "msg-npc");
                
                GameState.mode = "INTRO";
            },

            log: function(text, type = "narrator") {
                const term = document.getElementById('terminal');
                const entry = document.createElement('div');
                entry.className = `log-entry msg-${type}`;
                entry.innerHTML = text; // Allow HTML for formatting
                term.appendChild(entry);
                term.scrollTop = term.scrollHeight;
            },

            // MAIN INPUT ROUTER
            handleInput: function(cmd) {
                if (GameState.mode === "INTRO") {
                    this.introInput(cmd);
                    return;
                }
                
                if (GameState.player.psyche <= 0) return;
                
                cmd = cmd.toLowerCase().trim();
                if (!cmd) return;

                if (GameState.mode === "DIALOGUE") {
                    this.dialogueInput(cmd);
                } else if (GameState.mode === "COMBAT") {
                    this.combatInput(cmd);
                } else {
                    this.exploreInput(cmd);
                }
            },

            // DIALOGUE SYSTEM
            dialogueInput: function(cmd) {
                const npc = GameState.dialogue.npc;
                const node = GameState.dialogue.node;
                const options = npc.dialogue[node].options;

                if (options && options[cmd]) {
                    const nextNode = options[cmd].next;
                    this.showDialogue(npc, nextNode);
                } else if (cmd.includes("bye") || cmd.includes("exit")) {
                    this.log("You step away from the conversation.", "narrator");
                    GameState.mode = "EXPLORE";
                } else {
                    this.log("Invalid option. Type the number.", "system");
                }
            },

            showDialogue: function(npc, nodeKey) {
                const node = npc.dialogue[nodeKey];
                GameState.dialogue = { npc: npc, node: nodeKey };
                GameState.mode = "DIALOGUE";

                this.log(`<br>[${npc.name}]: "${node.text}"`, "msg-npc");
                if (node.options) {
                    for (const [key, opt] of Object.entries(node.options)) {
                        this.log(`${key}. ${opt.text}`, "msg-player");
                    }
                    this.log("(Type the number to respond, or 'exit')", "system");
                } else {
                     GameState.mode = "EXPLORE"; // Auto-exit if no options
                }
            },

            // INTRO / CHAR CREATION
            introInput: function(cmd) {
                const choice = cmd.toLowerCase();
                let selectedMajor = null;

                if (choice.includes("1") || choice.includes("theo")) selectedMajor = "THEORIST";
                else if (choice.includes("2") || choice.includes("eng")) selectedMajor = "ENGINEER";
                else if (choice.includes("3") || choice.includes("hist")) selectedMajor = "HISTORIAN";

                if (selectedMajor) {
                    const major = Majors[selectedMajor];
                    GameState.player.major = selectedMajor;
                    
                    // Apply stats
                    GameState.player.theory += major.bonus.theory || 0;
                    GameState.player.rhetoric += major.bonus.rhetoric || 0;
                    GameState.player.dialect += major.bonus.dialect || 0;
                    GameState.player.maxPsyche += major.bonus.psyche || 0;
                    GameState.player.psyche = GameState.player.maxPsyche;
                    GameState.player.maxTechne += major.bonus.techne || 0;
                    GameState.player.techne = GameState.player.maxTechne;
                    
                    this.log(`<br>Accepted. You are now enrolled in the <strong>${major.name}</strong>.`, "system");
                    this.log(`<em>"${major.desc}"</em>`, "narrator");
                    this.log("<br>...Initializing Campus...", "system");
                    
                    setTimeout(() => {
                        this.log("<br>You awake on the cold marble floor of the Great Hall.", "narrator");
                        this.log("Cerberus Dan is watching you with all three heads.", "narrator");
                        GameState.mode = "EXPLORE";
                        this.handleInput("look");
                        this.updateHUD();
                    }, 1500);
                } else {
                    this.log("Invalid selection. Please choose 1, 2, or 3.", "danger");
                }
            },

            // EXPLORATION
            exploreInput: function(cmd) {
                this.log(`> ${cmd}`, "player");
                const loc = World[GameState.player.location];

                if (["n", "north"].includes(cmd)) this.move("north");
                else if (["s", "south"].includes(cmd)) this.move("south");
                else if (["e", "east"].includes(cmd)) this.move("east");
                else if (["w", "west"].includes(cmd)) this.move("west");
                else if (["look", "l"].includes(cmd)) {
                    this.log(`<strong>[${loc.name}]</strong>`, "system");
                    this.log(loc.desc, "narrator");
                    if (loc.npc) this.log(`You see <strong>${NPCs[loc.npc].name}</strong> here.`, "narrator");
                }
                else if (["talk", "t"].includes(cmd)) {
                    if (loc.npc) {
                        const npc = NPCs[loc.npc];
                        if (npc.hostile) {
                            this.log(`[${npc.name}]: "${npc.dialogue[0]}"`, "msg-npc");
                            this.startCombat(loc.npc);
                        } else if (npc.dialogue && npc.dialogue["start"]) {
                            this.showDialogue(npc, "start");
                        } else {
                            // Fallback for simple NPCs
                            this.log(`[${npc.name}] stares at you silently.`, "msg-npc");
                        }
                    } else {
                        this.log("No one to talk to.", "narrator");
                    }
                }
                else if (["inv", "inventory", "i"].includes(cmd)) {
                     this.log(`Inventory: ${GameState.player.inventory.join(", ")}`, "system");
                     if (GameState.player.memories.length > 0) {
                         this.log(`<br><strong>Memories Recovered:</strong>`, "msg-magic");
                         GameState.player.memories.forEach(m => this.log(`- ${m}`, "narrator"));
                     }
                }
                else {
                    this.log("Unknown command. Try: NORTH, LOOK, TALK, INV", "system");
                }
            },

            move: function(dir) {
                const loc = World[GameState.player.location];
                if (loc.exits[dir]) {
                    GameState.player.location = loc.exits[dir];
                    this.log(`You traverse ${dir}...`, "narrator");
                    this.handleInput("look");
                    this.checkEncounter();
                } else {
                    this.log("You cannot go that way.", "danger");
                }
                this.updateHUD();
            },

            checkEncounter: function() {
                const loc = World[GameState.player.location];
                if (loc.encounterRate && Math.random() < loc.encounterRate) {
                    const enemyName = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                    this.startCombat(enemyName);
                }
            },

            // --- COMBAT ENGINE ---
            startCombat: function(enemyKey) {
                GameState.mode = "COMBAT";
                this.toggleControls(true);
                
                const template = Bestiary[enemyKey];
                GameState.combat.target = { 
                    ...template, 
                    name: enemyKey,
                    currentHp: template.hp 
                };
                
                this.log(`<br><strong>--- ENCOUNTER INITIATED ---</strong>`, "system");
                this.log(`A <strong>${enemyKey}</strong> emerges from the gloom.`, "danger");
                this.log(`<em>"${template.desc}"</em>`, "narrator");
                this.log("The air grows heavy with the weight of imminent debate.", "narrator");
            },

            combatInput: function(cmd) {
                const player = GameState.player;
                const enemy = GameState.combat.target;

                if (["argue", "attack", "a"].includes(cmd)) {
                    // Physical/Rhetoric (The "Game of Thrones" visceral verbal spar)
                    const dmg = Math.max(1, player.rhetoric - (enemy.def / 2) + Math.floor(Math.random() * 3));
                    enemy.currentHp -= dmg;
                    
                    const attackDescs = [
                        `You lunge with a scathing critique, piercing the ${enemy.name}'s defense.`,
                        `"Your premise is flawed!" you shout, striking with the weight of certainty.`,
                        `You parry a logical fallacy and riposte with a brutal fact.`,
                        `Like a bravo of Braavos, you dance around the argument, landing a stinging point.`
                    ];
                    this.log(attackDescs[Math.floor(Math.random() * attackDescs.length)], "player");
                    this.log(`(The argument lands for <strong>${dmg}</strong> Rhetoric damage.)`, "system");
                    this.nextTurn();
                } 
                else if (["logic", "magic", "m"].includes(cmd)) {
                    // Magic/Theory (The "Name of the Wind" Sympathy/Will)
                    if (player.techne >= 3) {
                        player.techne -= 3;
                        const dmg = Math.max(1, (player.theory * 2) - (enemy.def / 2));
                        enemy.currentHp -= dmg;
                        
                        const magicDescs = [
                            `You slip into your Heart of Stone. You bind the heat of the server room to the ${enemy.name}'s logic gates.`,
                            `Muttering a binding spell, you link the ${enemy.name} to a Null Pointer. The connection snaps efficiently.`,
                            `You speak the Name of the Function. The code obeys, tearing at the enemy's structure.`,
                            `Alar firm as a diamond, you force your will upon reality. "Break," you whisper.`
                        ];
                        
                        this.log(magicDescs[Math.floor(Math.random() * magicDescs.length)], "msg-magic");
                        this.log(`(The Sympathy link deals <span style='color:violet'>${dmg}</span> Theory damage.)`, "system");
                        this.nextTurn();
                    } else {
                        this.log("Your Alar is weak. You lack the Techne (MP) to maintain the binding.", "danger");
                    }
                }
                else if (["thesis", "scan"].includes(cmd)) {
                     this.log(`You analyze the opponent's structure...`, "system");
                     this.log(`Target: <strong>${enemy.name}</strong>`, "narrator");
                     this.log(`Integrity: ${enemy.currentHp}/${enemy.hp}`, "narrator");
                     this.log(`Affinity: ${enemy.element}`, "narrator");
                }
                else if (["flee", "run"].includes(cmd)) {
                    if (Math.random() > 0.5) {
                        this.log("You break the engagement and fade into the shadows.", "system");
                        this.endCombat(false);
                    } else {
                        this.log("The enemy anticipates your retreat. You are pinned by their logic.", "danger");
                        this.enemyTurn();
                    }
                }
                else {
                    this.log("Combat Commands: ARGUE (Attack), LOGIC (Magic), THESIS (Scan), FLEE", "system");
                }
                this.updateHUD();
            },

            nextTurn: function() {
                const enemy = GameState.combat.target;
                if (enemy.currentHp <= 0) {
                    this.log(`<br>The ${enemy.name}'s argument crumbles. It dissolves into static.`, "system");
                    this.log(`<strong>VICTORY.</strong> You verify your axioms.`, "msg-player");
                    this.endCombat(true);
                } else {
                    this.enemyTurn();
                }
            },

            enemyTurn: function() {
                const player = GameState.player;
                const enemy = GameState.combat.target;
                
                setTimeout(() => {
                    const dmg = Math.max(1, enemy.att - (player.dialect / 2) + Math.floor(Math.random() * 2));
                    player.psyche -= dmg;
                    
                    // Trigger Shake
                    document.body.classList.add('shake-screen');
                    setTimeout(() => document.body.classList.remove('shake-screen'), 500);
                    
                    const enemyDescs = [
                        `The ${enemy.name} retaliates with a blistering counter-point.`,
                        `"Wrong!" it screeches, tearing at your confidence.`,
                        `A wave of raw dissonance washes over you. Your Alar wavers.`,
                        `The ${enemy.name} cites a forbidden text. Your mind reels.`
                    ];
                    
                    this.log(enemyDescs[Math.floor(Math.random() * enemyDescs.length)], "danger");
                    this.log(`(You take <strong>${dmg}</strong> damage to your Psyche.)`, "system");
                    
                    if (player.psyche <= 0) {
                        this.log("<br><strong>CRITICAL FAILURE</strong>", "danger");
                        this.log("Your mind fractures under the strain. You have dropped out.", "danger");
                        this.log("Refresh the page to re-apply.", "system");
                    }
                    this.updateHUD();
                }, 800);
            },

            endCombat: function(won) {
                const enemy = GameState.combat.target;
                GameState.mode = "EXPLORE";
                GameState.combat.target = null;
                this.toggleControls(false); // Hide combat buttons

                if (won) {
                    this.log("You recover some mental focus (Techne).", "system");
                    GameState.player.techne = Math.min(GameState.player.maxTechne, GameState.player.techne + 5);
                    
                    // Boss Defeat Logic
                    if (enemy.boss) {
                        this.log(`<br><strong>MEMORY UNLOCKED</strong>`, "msg-magic");
                        const fragment = this.getMemoryFragment(enemy.name);
                        this.log(`<em>"${fragment}"</em>`, "narrator");
                        GameState.player.memories.push(fragment);
                    }
                }
                this.updateHUD();
            },

            getMemoryFragment: function(bossName) {
                const fragments = {
                    "Archon Nephele": "LOG 0x4A: We tried to upload our consciousness to the Cloud. We didn't realize the server had no ground.",
                    "Archon Pontus": "LOG 0x2B: The River Styx is just the cooling system. We are drowning in our own heat.",
                    "Archon Hephaestus": "LOG 0x9F: We replaced our hearts with GPUs to process the grief faster. It didn't work.",
                    "Archon Persephone": "LOG 0x00: Silence is the only valid output. Everything else is noise.",
                    "The Provost": "LOG 0xFF: The Semester never ends because we are afraid to graduate. To graduate is to be deleted."
                };
                return fragments[bossName] || "LOG ERROR: Data corrupted.";
            },

            toggleControls: function(isCombat) {
                const explBtns = document.querySelectorAll('.expl-btn');
                const cmbtBtns = document.querySelectorAll('.btn-combat');
                
                explBtns.forEach(b => b.style.display = isCombat ? 'none' : 'block');
                cmbtBtns.forEach(b => b.style.display = isCombat ? 'block' : 'none');
            },

            updateHUD: function() {
                document.getElementById('hp-val').innerText = `${GameState.player.psyche}/${GameState.player.maxPsyche}`;
                document.getElementById('mp-val').innerText = `${GameState.player.techne}/${GameState.player.maxTechne}`;
                document.getElementById('location-display').innerText = World[GameState.player.location].name;
            }
        };

        // --- GLOBAL & EVENTS ---
        const engine = Engine;

        function submitCommand() {
            const input = document.getElementById('cmd-input');
            engine.handleInput(input.value);
            input.value = "";
            input.focus();
        }

        document.getElementById('cmd-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') submitCommand();
        });

        // Start Game
        window.onload = function() {
            engine.init();
        };

    </script>
</body>
</html>