<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Solver View: McKean-Vlasov Dynamics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; background: #000; color: #a7a9be; font-family: monospace; overflow: hidden; }
        #canvas { display: block; cursor: crosshair; }
        
        #ui {
            position: absolute; top: 20px; left: 20px;
            background: rgba(20, 20, 30, 0.85);
            padding: 20px; border-radius: 8px; border: 1px solid #ff8906;
            max-width: 300px; z-index: 10;
        }
        h1 { margin: 0 0 10px 0; color: #ff8906; font-size: 1.2rem; }
        .math { font-style: italic; color: #f25f4c; margin-bottom: 10px; font-size: 0.9rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .val { color: #fffffe; font-weight: bold; }

        /* God View Panel */
        #god-panel {
            display: none;
            position: absolute; top: 20px; right: 20px;
            background: rgba(10, 10, 15, 0.95);
            padding: 20px; border: 2px solid #00ffff;
            border-radius: 8px; width: 320px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); z-index: 20;
        }
        .god-header { color: #00ffff; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: #ccc; margin-bottom: 5px; }
        select, input[type=range], button { width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 5px; }
        button { cursor: pointer; margin-top: 5px; }
        button:hover { background: #333; border-color: #00ffff; }

        #inspector {
            display: none;
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #fff; padding: 15px;
            width: 400px; height: 200px; z-index: 15;
        }
        
        #passcode-modal {
            position: absolute; bottom: 10px; right: 10px;
            opacity: 0.3; transition: opacity 0.3s; z-index: 30;
        }
        #passcode-modal:hover { opacity: 1; }
        #passcode-input { background: #333; border: 1px solid #555; color: #fff; padding: 5px; }

        a.math-link { color: #00ffff; text-decoration: none; font-size: 0.8rem; display: block; margin-top: 10px; text-align: center; }
        a.math-link:hover { text-decoration: underline; }

    </style>
</head>
<body>
    <div id="ui">
        <h1>Mean Field Simulation</h1>
        <div class="math">dX_t = -âˆ‡V(X_t)dt - âˆ‡W*Î¼_t(X_t)dt + ÏƒdB_t</div>
        <div id="stats-container">
            <div class="stat-row"><span>Step:</span> <span id="step" class="val">0</span></div>
            <div class="stat-row"><span>Mean Energy E[V]:</span> <span id="mean-e" class="val">0</span></div>
            <div class="stat-row"><span>Variance Var[X]:</span> <span id="var-x" class="val">0</span></div>
            <div class="stat-row"><span>Entropy S:</span> <span id="entropy" class="val">0</span></div>
        </div>
        <a href="math.html" target="_blank" class="math-link">View Mathematical Theory â†’</a>
    </div>

    <!-- God View Panel -->
    <div id="god-panel">
        <div class="god-header">ðŸ¦‰ THE SOLVER VIEW</div>
        
        <div class="control-group">
            <label>Population (N): <span id="val-n">50</span></label>
            <input type="range" id="slider-n" min="10" max="200" step="10" value="50">
        </div>

        <div class="control-group">
            <label>Drift Potential V(x)</label>
            <select id="sel-v">
                <option value="quadratic">Quadratic (Gravity)</option>
                <option value="double_well">Double-Well (Bifurcation)</option>
                <option value="rastrigin">Rastrigin (Multi-modal)</option>
                <option value="flat">Zero (Brownian)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Interaction Kernel W(x-y)</label>
            <select id="sel-w">
                <option value="coulomb">Coulomb (Repulsion)</option>
                <option value="newtonian">Newtonian (Attraction)</option>
                <option value="morse">Swarm (Attract-Repel)</option>
                <option value="none">Zero (Independent)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Noise (Sigma): <span id="val-sigma">0.5</span></label>
            <input type="range" id="slider-noise" min="0" max="5" step="0.1" value="0.5">
        </div>

        <div class="control-group">
            <label>Step Size (dt): <span id="val-dt">0.1</span></label>
            <input type="range" id="slider-dt" min="0.01" max="0.5" step="0.01" value="0.1">
        </div>

        <div class="control-group">
            <label>Sim Speed (Delay ms)</label>
            <input type="range" id="slider-speed" min="0" max="200" step="10" value="0">
        </div>
        
        <div class="control-group">
            <label><input type="checkbox" id="chk-field"> Show Gradient Field</label>
            <label><input type="checkbox" id="chk-contour" checked> Show Potential Contour</label>
            <label><input type="checkbox" id="chk-history"> Show Trajectories</label>
        </div>
    </div>

    <!-- Inspector Panel -->
    <div id="inspector">
        <div style="color:#fff; border-bottom:1px solid #555; margin-bottom:5px;">AGENT <span id="insp-id">#</span> TRACKER</div>
        <canvas id="chart-canvas"></canvas>
    </div>

    <div id="passcode-modal">
        <input type="password" id="passcode-input" placeholder="GM Access">
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // --- HASH VERIFICATION (SHA-256) ---
        // Hash for "1303": e206a54e97690cce50cc872dd70ee8966ef85f9c3e625d970543568e495691
        async function verifyPasscode(input) {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            if (hashHex === "e206a54e97690cce50cc872dd70ee8966ef85f9c3e625d970543568e495691") {
                document.getElementById('god-panel').style.display = 'block';
                document.getElementById('passcode-modal').style.display = 'none';
            }
        }

        document.getElementById('passcode-input').addEventListener('input', (e) => verifyPasscode(e.target.value));

        // --- SIMULATION ENGINE ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // State
        let N = 50;
        let dt = 0.1;
        let sigma = 0.5;
        let vType = 'quadratic';
        let wType = 'coulomb';
        let delay = 0;
        
        let agents = [];
        let step = 0;
        let selectedAgent = null;
        let chart = null;
        
        const COLORS = ["#ff8906", "#e53170", "#f25f4c", "#a7a9be", "#2cb67d"];

        // Initialization
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function initAgents() {
            agents = [];
            for(let i=0; i<N; i++) {
                agents.push({
                    id: i,
                    x: (Math.random() - 0.5) * width/2 + width/2, // Center-ish bias
                    y: (Math.random() - 0.5) * height/2 + height/2,
                    vx: 0, vy: 0,
                    type: i % 5,
                    history: [],
                    energyLog: []
                });
            }
            if(selectedAgent >= N) selectedAgent = null; // Reset selection if N shrinks
        }

        // --- POTENTIALS & KERNELS ---
        function getV(x, y) {
            const cx = width/2, cy = height/2;
            const dx = (x - cx)/100; // Normalize coords
            const dy = (y - cy)/100;
            
            if (vType === 'quadratic') return 0.5 * (dx*dx + dy*dy);
            if (vType === 'double_well') return 0.25 * Math.pow(dx*dx - 4, 2) + 0.5*dy*dy; // Bifurcation on X
            if (vType === 'rastrigin') return 10 * 2 + (dx*dx - 10*Math.cos(2*Math.PI*dx)) + (dy*dy - 10*Math.cos(2*Math.PI*dy));
            return 0; // Flat
        }

        function getGradV(x, y) {
            const cx = width/2, cy = height/2;
            const dx = (x - cx)/100;
            const dy = (y - cy)/100;
            let gx=0, gy=0;

            if (vType === 'quadratic') { gx=dx; gy=dy; }
            else if (vType === 'double_well') { gx = dx*(dx*dx - 4); gy = dy; }
            else if (vType === 'rastrigin') { 
                gx = 2*dx + 20*Math.PI*Math.sin(2*Math.PI*dx); 
                gy = 2*dy + 20*Math.PI*Math.sin(2*Math.PI*dy); 
            }
            return { x: gx/10, y: gy/10 }; // Scale back
        }

        function getGradW(rx, ry) {
            const r2 = rx*rx + ry*ry;
            const r = Math.sqrt(r2);
            if (r < 1) return {x:0, y:0}; // Softening

            let mag = 0;
            if (wType === 'coulomb') mag = 1000 / (r2 * r); // Repel
            if (wType === 'newtonian') mag = -0.5; // Constant Attract (simplified)
            if (wType === 'morse') { // Short repel, long attract
                mag = -20 * (Math.exp(-r/50) - Math.exp(-r/20)); 
            }
            
            return { x: rx * mag, y: ry * mag };
        }

        // --- DYNAMICS LOOP ---
        function update() {
            let meanE = 0;
            let varX = 0;
            const cx = width/2, cy = height/2;

            for(let i=0; i<N; i++) {
                let a = agents[i];
                
                // Drift
                let gradV = getGradV(a.x, a.y);
                let fx = -gradV.x;
                let fy = -gradV.y;

                // Interaction
                if (wType !== 'none') {
                    let ix=0, iy=0;
                    for(let j=0; j<N; j++) {
                        if(i===j) continue;
                        let gw = getGradW(a.x - agents[j].x, a.y - agents[j].y);
                        ix += gw.x; iy += gw.y;
                    }
                    fx += ix / N;
                    fy += iy / N;
                }

                // Noise
                fx += (Math.random() - 0.5) * sigma * 10;
                fy += (Math.random() - 0.5) * sigma * 10;

                // Euler-Maruyama
                a.vx = fx; a.vy = fy;
                a.x += a.vx * dt;
                a.y += a.vy * dt;

                // Bounds (Reflect)
                if(a.x < 0 || a.x > width) { a.x = Math.max(0, Math.min(width, a.x)); }
                if(a.y < 0 || a.y > height) { a.y = Math.max(0, Math.min(height, a.y)); }

                // Stats
                let pot = getV(a.x, a.y);
                meanE += pot;
                varX += (a.x - cx)**2 + (a.y - cy)**2;

                // Log
                if(step % 10 === 0 && selectedAgent === i) {
                    a.energyLog.push(pot);
                    if(a.energyLog.length > 50) a.energyLog.shift();
                }
            }

            // Update UI Stats
            document.getElementById('mean-e').innerText = (meanE / N).toFixed(2);
            document.getElementById('var-x').innerText = (varX / N).toFixed(0);
            // Rough Entropy Estimator (Space filling)
            // Divide space into 10x10 grid
            let grid = new Array(100).fill(0);
            agents.forEach(a => {
                let gx = Math.floor(a.x / (width/10));
                let gy = Math.floor(a.y / (height/10));
                if(gx>=0 && gx<10 && gy>=0 && gy<10) grid[gy*10+gx]++;
            });
            let entropy = 0;
            grid.forEach(c => {
                if(c > 0) {
                    let p = c/N;
                    entropy -= p * Math.log(p);
                }
            });
            document.getElementById('entropy').innerText = entropy.toFixed(3);
        }

        // --- DRAWING ---
        function drawContour() {
            if(!document.getElementById('chk-contour').checked) {
                ctx.fillStyle = '#0f0e17';
                ctx.fillRect(0,0,width,height);
                return;
            }
            
            // Low-res heatmap for performance
            const res = 20;
            for(let x=0; x<width; x+=res) {
                for(let y=0; y<height; y+=res) {
                    let v = getV(x, y);
                    // Map V to color (Blue low, Red high)
                    let int = Math.min(255, Math.floor(v * 20));
                    ctx.fillStyle = `rgb(${int/2}, 0, ${50 + int/2})`; // Purple-ish gradient
                    ctx.fillRect(x, y, res, res);
                }
            }
        }

        function draw() {
            drawContour();

            for(let i=0; i<N; i++) {
                let a = agents[i];
                ctx.beginPath();
                ctx.arc(a.x, a.y, 6, 0, Math.PI*2);
                ctx.fillStyle = COLORS[a.type];
                
                if(selectedAgent === i) {
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
                }
                ctx.fill();
            }
        }

        // --- MAIN LOOP ---
        function loop() {
            update();
            draw();
            step++;
            document.getElementById('step').innerText = step;
            if(selectedAgent !== null && chart) {
                chart.data.datasets[0].data = agents[selectedAgent].energyLog;
                chart.update('none');
            }
            setTimeout(() => requestAnimationFrame(loop), delay);
        }

        // --- CONTROLS HOOKS ---
        document.getElementById('slider-n').addEventListener('input', e => {
            N = parseInt(e.target.value);
            document.getElementById('val-n').innerText = N;
            initAgents(); // Re-init on N change
        });
        document.getElementById('sel-v').addEventListener('change', e => vType = e.target.value);
        document.getElementById('sel-w').addEventListener('change', e => wType = e.target.value);
        document.getElementById('slider-noise').addEventListener('input', e => {
            sigma = parseFloat(e.target.value);
            document.getElementById('val-sigma').innerText = sigma;
        });
        document.getElementById('slider-dt').addEventListener('input', e => {
            dt = parseFloat(e.target.value);
            document.getElementById('val-dt').innerText = dt;
        });
        document.getElementById('slider-speed').addEventListener('input', e => delay = parseInt(e.target.value));

        // Inspector Click
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            let closest = -1; let minD = 1000;
            for(let i=0; i<N; i++) {
                let d = Math.hypot(agents[i].x - mx, agents[i].y - my);
                if(d < 30 && d < minD) { minD = d; closest = i; }
            }
            if(closest !== -1) {
                selectedAgent = closest;
                document.getElementById('inspector').style.display = 'block';
                document.getElementById('insp-id').innerText = closest;
            } else {
                selectedAgent = null;
                document.getElementById('inspector').style.display = 'none';
            }
        });

        // Chart Init
        const ctxChart = document.getElementById('chart-canvas').getContext('2d');
        chart = new Chart(ctxChart, {
            type: 'line',
            data: { labels: Array(50).fill(''), datasets: [{ label: 'V(X)', data: [], borderColor: '#fff', borderWidth: 1 }] },
            options: { responsive: true, animation: false, scales: { x: {display:false}, y: {display:true} }, plugins: {legend:{display:false}} }
        });

        initAgents();
        loop();

    </script>
</body>
</html>